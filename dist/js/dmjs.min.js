/*
 dmjs 2016-05-19 
*/
function ClusterEvaluation(){function a(a,b){for(var c=0,d=0;d<a.length;d++)c+=(a[d]-b[d])*(a[d]-b[d]);return Math.sqrt(c)}function b(a,b){for(var c=0,d=0;d<a.length;d++)c+=(a[d]-b[d])*(a[d]-b[d]);return c}function c(){var a=null,b=0;return f.forEach(function(c){var d=g(c);b+=d.length,d.forEach(function(b,c){var d=i(b);if(isArray(d)){a||(a=d.map(function(){return 0}));for(var e=0;e<a.length;e++)a[e]+=d[e]}else a||(a=0),a+=d})}),isArray(a)?a=a.map(function(a){return a/b}):a/=b,a}function d(){for(var a=[],b=0;b<f.length;b++)for(var c=f[b],d=g(c),h=0;h<d.length;h++){var j=d[h].name,k=e(d[h],c);a.push({name:j,point:i(d[h]),value:k})}return a}function e(a,b){function c(a,b){for(var c=null,d=0;d<f.length;d++)if(b==f[d].name){c=f[d];break}return e(a,c)}function e(a,b){var c=g(b),d=c.map(i),e=0;if(d.length>1){for(var h=0;h<d.length;h++){var k=j(a,d[h]);e+=k}e/=d.length-1}for(var l=1/0,h=0;h<f.length;h++)if(b.name!=f[h].name){var m=g(f[h]),n=m.map(i),o=0;n.forEach(function(b){o+=j(a,b)}),o/=n.length,l>o&&(l=o)}return(l-e)/Math.max(e,l)}if(0==arguments.length)return d();if(1==arguments.length){var b=function(){for(var b=0;b<f.length;b++)for(var c=g(f[b]),d=0;d<c.length;d++){var e=c[d].name;if(e==a.name)return f[b]}}();return e(i(a),b)}return"[object String]"===Object.prototype.toString.call(b)?c(i(a),b):e(i(a),b)}var f,g=function(a){return a.value.points},h=function(a){return a.value.centroid},i=function(a){return a.value.point},j=a;this.centroid_of_all_points=c,this.WSS=function(){var a=0;return f.forEach(function(b){var c,d=g(b),e=h(b);c=null===e||void 0===e?(new Evaluation).data(d).accessor(i).SSE():(new Evaluation).data(d).accessor(i).SSE(h(b)),a+=c}),a},this.BSS=function(){var a=0,d=c();return f.forEach(function(c){var e=g(c);if(e.length>0){var f=h(c);null!==f&&void 0!==f||(f=i(e[0]).map(function(){return 0}),e.forEach(function(a){for(var b=i(a),c=0;c<f.length;c++)f[c]+=b[c]}),f=f.map(function(a){return a/e.length})),a+=e.length*b(f,d)}}),a},this.TSS=function(){var a=0,d=c();return f.forEach(function(c){var e=g(c);if(e.length>0){var f=e.map(i);f.forEach(function(c){a+=b(c,d)})}}),a},this.silhouette_coefficient=function(a,b){return 0===arguments.length?e():1==arguments.length?e(a):e(a,b)},this.data=function(a){return arguments.length>0?(f=a,this):f},this.points_accessor=function(a){return arguments.length>0?(g=a,this):g},this.point_accessor=function(a){return arguments.length>0?(i=a,this):i},this.centroid_accessor=function(a){return arguments.length>0?(h=a,this):h},this.silhouette_dist_metric=function(a){return arguments.length>0?(j=a,this):j}}function Evaluation(){function a(a,b){for(var c=0,d=0;d<a.length;d++)c+=(a[d]-b[d])*(a[d]-b[d]);return c}var b,c=function(a){return a};this.SSE=function(d){var e=b.map(c);if(0==arguments.length)var d=mean(e);for(var f=0,g=0;g<e.length;g++)f+=a(e[g],d);return f},this.data=function(a){return arguments.length>0?(b=a,this):b},this.accessor=function(a){return arguments.length>0?(c=a,this):c}}function HierachicalCluster(){function a(a,b,d,e,f,g,h,i){var j=k.get(c(d,b)),l=k.get(c(e,b)),m=k.get(c(d,e));return f*j.dist+g*l.dist+h*m.dist+i*Math.abs(j.dist-l.dist)}function b(a,b){var e={id:w,children:[a,b],metric:k.get(c(a,b)).dist,m:a.m+b.m};for(e.name=x(e),f=o.length;f--;)o[f].id!=a.id&&o[f].id!=b.id||o.splice(f,1);o.forEach(function(a,b){var c=u(e,a);j.push(d(e,a,c))});for(var f=j.length;f--;)j[f].from.id!=a.id&&j[f].to.id!=a.id&&j[f].from.id!=b.id&&j[f].to.id!=b.id||j.splice(f,1);j.sort(function(a,b){return a.dist-b.dist}),k=d3.map(j,function(a){return a.id}),o.push(e),++w}function c(a,b){return a.id<b.id?a.id+"-"+b.id:b.id+"-"+a.id}function d(a,b,c){return a.id<b.id?{id:a.id+"-"+b.id,from:a,to:b,dist:c}:{id:b.id+"-"+a.id,from:b,to:a,dist:c}}function e(a){var b=[];return 0==arguments.length?f(m,b):f(a,b),b}function f(a,b){null!=a&&(a.children&&0!=a.children.length||b.push(a),a.children&&a.children.forEach(function(a){f(a,b)}))}function g(a){function b(c,d){null!=c&&(c.metric<a?d.push(c):c.children&&c.children.forEach(function(a){b(a,d)}))}console.log("root",m);var c=[];return b(m,c),c}function h(a){function b(c){if(c.length<a){for(var d=-(1/0),e=-1,f=0;f<c.length;f++)c[f].metric>d&&c[f].children&&c[f].children.length>0&&(d=c[f].metric,e=f);if(e>=0){var g=c[e];g.children&&(c.splice(e,1),g.children.forEach(function(a){c.push(a)})),b(c)}}}var c=[m];return b(c),c}var i,j,k,l,m,n,o,p=[],q=function(a){return a.value.point},r=[],s=!1,t=function(a,b){for(var c=0,d=0;d<a.length;d++)c+=(a[d]-b[d])*(a[d]-b[d]);return Math.sqrt(c)},u=function(b,c){var d=b.children[0],e=b.children[1];return a(b,c,d,e,.5,.5,0,.5)},v="distance",w=0,x=function(a){var b=a.id+1;return b.toString()};this.init=function(){n=l.map(function(a,b){return{id:b,name:a.name,value:{point:q(a)},m:1,metric:0}}),o=n.slice(0),w=n.length;for(var a=0;a<n.length;a++)for(var b=n[a].value.point,c=a+1;c<n.length;c++){var d=n[c].value.point,e=t(b,d);p.push({id:n[a].id+"-"+n[c].id,from:n[a],to:n[c],dist:e})}return i=p.slice(0),j=p.slice(0),j.sort(function(a,b){return a.dist-b.dist}),k=d3.map(j,function(a){return a.id}),this},this.cluster=function(){for(;o.length>1;){s&&r.push(JSON.parse(JSON.stringify(j)));var a=j[0];b(a.from,a.to)}return m=o[0],this},this.cut=function(a){if("K"===v)var b=h(a);else if("distance"===v)var b=g(a);var c=[];return b.forEach(function(a){var b=e(a),d=b.map(function(a){return{name:a.name,value:{point:a.value.point}}});c.push({name:a.name,id:a.id,value:{points:d}})}),c},this.pair2matrix=function(a){var b=a.slice(0);b.sort(function(a,b){return a.from.id-b.from.id});var c=[],d=0,e=d3.map(),f=[];return b.forEach(function(a){e.has(a.from.id)||e.set(a.from.id,d++),e.has(a.to.id)||f.push(a)}),f.forEach(function(a){e.has(a.to.id)||e.set(a.to.id,d++)}),b.forEach(function(a){var b=e.get(a.from.id),d=e.get(a.to.id);c[b]||(c[b]=[]),c[d]||(c[d]=[]),c[b][d]={value:a.dist,from_name:a.from.name,from_id:a.from.id,to_name:a.to.name,to_id:a.to.id},c[d][b]={value:a.dist,from_name:a.to.name,from_id:a.to.id,to_name:a.from.name,to_id:a.from.id},c[b][b]||(c[b][b]={value:0,from_name:a.from.name,from_id:a.from.id,to_name:a.from.name,to_id:a.from.id}),c[d][d]||(c[d][d]={value:0,from_name:a.to.name,from_id:a.to.id,to_name:a.to.name,to_id:a.to.id})}),c},this.data=function(a){return arguments.length>0?(l=a,this):l},this.accessor=function(a){return arguments.length>0?(q=a,this):q},this.root=function(a){return arguments.length>0?(m=a,this):m},this.dist_fun=function(b){if(0==arguments.length)return u;if("[object String]"===Object.prototype.toString.call(b)){switch(b){case"min":u=function(b,c){var d=b.children[0],e=b.children[1];return a(b,c,d,e,.5,.5,0,-0.5)};break;case"max":u=function(b,c){var d=b.children[0],e=b.children[1];return a(b,c,d,e,.5,.5,0,.5)};break;case"group_average":u=function(b,c){var d=b.children[0],e=b.children[1],f=d.m/(d.m+e.m),g=e.m/(d.m+e.m);return a(b,c,d,e,f,g,0,0)};break;case"centroid":u=function(b,c){var d=b.children[0],e=b.children[1],f=d.m/(d.m+e.m),g=e.m/(d.m+e.m),h=-d.m*e.m/((d.m+e.m)*(d.m+e.m));return a(b,c,d,e,f,g,h,0)};break;case"ward":u=function(b,c){var d=b.children[0],e=b.children[1],f=(d.m+c.m)/(d.m+e.m+c.m),g=(e.m+c.m)/(d.m+e.m+c.m),h=-c.m/(d.m+e.m+c.m);return a(b,c,d,e,f,g,h,0)}}return this}return u=b,this},this.dist_metric=function(a){return arguments.length>0?(t=a,this):t},this.save_history=function(a){return arguments.length>0?(s=a,this):s},this.cut_opt=function(a){return arguments.length>0?(v=a,this):v},this.leafPairs=function(){return i},this.topPairs=function(){return j},this.pairs=function(){return p},this.history=function(){return r}}function KMean(){function a(a,b){for(var c=0,d=0;d<a.length;d++)c+=(a[d]-b[d])*(a[d]-b[d]);return Math.sqrt(c)}function b(a){if(0==a.length)return 0;if(isArray(a[0])){for(var b=Array(a[0].length).fill(0),c=0;c<a.length;c++)for(var d=0;d<a[c].length;d++)b[d]+=a[c][d];return b.map(function(b){return b/a.length})}for(var b=0,c=0;c<a.length;c++)b+=a[c];return b/a.length}function c(a){if(0==a.length)return 0;if(!isArray(a[0])){var b=a.slice(0);return b.sort(function(a,b){return a-b}),b[b.length/2]}var b=a.slice(0)}var d,e,f=function(a){return a.value.point},g=null,h=0,i=!1,j=!1,k=[],l=null,m=function(a,b){for(var c=0,d=0;d<a.length;d++)c+=(a[d]-b[d])*(a[d]-b[d]);return Math.sqrt(c)},n=function(a){return b(a)};this.cluster=function(){var b=!0,c=0;do++c,e.forEach(function(a){a.value.points=[]}),d.forEach(function(a){var b=e[0],c=Number.POSITIVE_INFINITY;e.forEach(function(d){var e=f(a),g=m(e,d.value.centroid);c>g&&(c=g,b=d)}),b.value.points.push(a)}),b=!1,e.forEach(function(c){if(c.value.points.length>0){var d=c.value.points.map(f),e=n(d),g=a(e,c.value.centroid);c.value.centroid=e,g>h&&(b=!0)}}),j&&(l=0,e.forEach(function(a){var b=(new Evaluation).data(a.value.points).accessor(function(a){return a.value.point}).SSE(a.value.centroid);a.value.sse=b,l+=b})),i&&k.push(JSON.parse(JSON.stringify(e))),g&&c>=g&&(b=!1);while(b);return this},this.data=function(a){return arguments.length>0?(d=a,this):d},this.accessor=function(a){return arguments.length>0?(f=a,this):f},this.dist_metric=function(a){return arguments.length>0?(m=a,this):m},this.clusters=function(a){return arguments.length>0?(e=a,this):e},this.numIteration=function(a){return arguments.length>0?(g=a,this):g},this.stopThreshold=function(a){return arguments.length>0?(h=a,this):h},this.save_history=function(a){return arguments.length>0?(i=a,this):i},this.evaluate_sse=function(a){return arguments.length>0?(j=a,this):j},this.centroid_fun=function(a){if(0==arguments.length)return n;if("[object String]"===Object.prototype.toString.call(a)){switch(a){case"mean":n=b;break;case"median":n=c;default:n=b}return this}return n=a,this},this.history=function(){return k},this.sse=function(){return l}}function SparseVector(a,b,c){function d(a,b){"use strict";for(var c,d,e=0,f=b.length-1;f>=e;)if(c=(e+f)/2|0,d=b[c],a>d)e=c+1;else{if(!(d>a))return c;f=c-1}return 0===e?-(1/0):-e}function e(a,b){for(var c=[],d=0,e=0,f=0;d<a.length&&e<b.length;)a[d]<b[e]?(c[f]=a[d],++d,++f):a[d]>b[e]?(c[f]=b[e],++e,++f):(c[f]=a[d],++d,++e,++f);for(;d<a.length;)c[f]=a[d],++d,++f;for(;e<b.length;)c[f]=b[e],++e,++f;return c}var f=this;a?this.indices=a:this.indices=[],b?this.values=b:this.values=[],c?this.size=c:0==this.indices.length?this.size=0:this.size=this.indices[this.indices.length-1]+1,this.toDenseVector=function(){for(var a=[],b=0;b<this.size;b++)a[b]=this.getValue(b);return a},this.setValue=function(a,b){var c=this.locationAtIndex(a);c>=0?this.values[c]=b:c===-(1/0)?(a>=this.size&&(this.size=a+1),this.indices.splice(0,0,a),this.values.splice(0,0,b)):(a>=this.size&&(this.size=a+1),this.indices.splice(-c,0,a),this.values.splice(-c,0,b))},this.diff=function(a){},this.sum=function(a){"use strict";var b=e(f.indices,a.indices),c=[];return b.forEach(function(b,d){var e=f.locationAtIndex(b),g=a.locationAtIndex(b);e>=0&&g>=0?c[d]=f.values[e]+a.values[g]:e>=0?c[d]=f.values[e]:g>=0&&(c[d]=a.values[g])}),new SparseVector(b,c,Math.max(f.size,a.size))},this.L2norm=function(){"use strict";var a=f.values.reduce(function(a,b,c){return a+b*b},0);return Math.sqrt(a)},this.dotp=function(a){var b=0,c=new Set;return f.indices.forEach(function(a){c.add(a)}),a.indices.forEach(function(a){c.add(a)}),c.forEach(function(c){var d=f.locationAtIndex(c),e=a.locationAtIndex(c);d>=0&&e>=0&&(b+=f.values[d]*a.values[e])}),b},this.locationAtIndex=function(a){return d(a,f.indices)},this.indexAtLocation=function(a){return f.indices[a]},this.getValue=function(a){var b=f.locationAtIndex(a),c=f.values[b];return c?f.values[b]:0},this.cosineSimilarity=function(a){return f.dotp(a)/(f.L2norm()*a.L2norm())}}function array2clustering(a){var b=0;return a.map(function(a,c){return{name:"C"+c,value:{points:a.map(function(a,c){return++b,{name:b.toString(),value:{point:a}}})}}})}function array2points(a){return a.map(function(a,b){return{name:(b+1).toString(),value:{point:a}}})}function nominal_distnace(a,b){return a===b?1:0}function nominal_similarity(a,b){return 1-nominal_distance(a,b)}function ordinal_distance(a,b,c){return Math.abs(a-b)/(c-1)}function ordian_similarity(a,b,c){return 1-ordinal_distance(a,b,c)}function ratio_distance(a,b){return Math.abs(a-b)}function ratio_similarity(a,b,c,d){return 2==arguments.length?1-ratio_distance(a,b):4==arguments.length?1-(ratio_distance(a,b)-c)/(d-c):void 0}function ratio_similarity1(a,b){return-ratio_distance(a,b)}function euclidean_distance(a,b){for(var c=0,d=0;d<a.length;d++)c+=(a[d]-b[d])*(a[d]-b[d]);return Math.sqrt(c)}function minkowski_distance(a,b,c){if(c==1/0){for(var d=-(1/0),e=0;e<a.length;e++){var f=Math.abs(a[e]-b[e]);f>max&&(max=f)}return d}for(var g=0,e=0;e<a.length;e++)g+=Math.pow(Math.abs(a[e]-b[e]),c);return Math.pow(g,1/c)}function mahalanobis_distance(a,b,c){}function jaccard_similarity(a,b){for(var c=0,d=0,e=0,f=0,g=0;g<a.length;g++)a[g]==b[g]==1?++f:1==a[g]&&0==b[g]?++d:0==a[g]&&1==b[g]?++c:0==a[g]&&0==b[g]&&++e;return c+d+f>0?f/(c+d+f):1}function jaccard_distance(a,b){return 1-jaccard_similarity(a,b)}function tanimoto_similarity(a,b){for(var c=0,d=0;d<a.length;d++)c+=a[d]*b[d];for(var e=0,d=0;d<a.length;d++)e+=a[d]*a[d];for(var f=0,d=0;d<b.length;d++)f+=b[d]*b[d];return c/(e+f-c)}function tanimoto_distance(a,b){return 1-tanimoto_similarity(a,b)}function smc_similarity(a,b){for(var c=0,d=0,e=0,f=0,g=0;g<a.length;g++)a[g]==b[g]==1?++f:1==a[g]&&0==b[g]?++d:0==a[g]&&1==b[g]?++c:0==a[g]&&0==b[g]&&++e;return(f+e)/(c+d+f+e)}function smc_distance(a,b){return 1-smc_similarity(a,b)}function cosine_distance(a,b){return 1-cosine_similarity(a,b)}function cosine_similarity(a,b){for(var c=0,d=0;d<a.length;d++)c+=a[d]*b[d];return c/(L2_norm(a)*L2_norm(b))}function correlation_similarity(a,b){var c=mean(a),d=mean(b),e=std(a),f=std(b);if(0==e&&0==f)return 1;if(0==e||0==f)return 0;var g=a.map(function(a){return(a-c)/e}),h=b.map(function(a){return(a-d)/f});return dotp(g,h)}function correlation_distance(a,b){return-correlation_similarity(a,b)}function corr(a){if(0==a.length)return 0;if(isArray(a[0])){for(var b=cov(a),c=std(a),d=0;d<b.length;d++)for(var e=0;e<b.length;e++)c[d]==c[e]==0?b[d][e]=1:0==standard_div[d]||0==c[e]?b[d][e]=0:b[d][e]/=c[d]*c[e];return b}return std(a)}function cov(a){if(0==a.length)return 0;if(isArray(a[0])){for(var b=mean(a),c=Array(a[0].length).fill(Array(a[0].length).fill(0)),d=0;d<a[0].length;d++)for(var e=0;e<a[0].length;e++){for(var f=0,g=0;g<a.length;g++)f+=(a[g][d]-b[d])*(a[g][e]-b[e]);c[d][e]=f/a.length}return c}return variance(a)}function variance(a){if(0==a.length)return 0;if(isArray(a[0])){for(var b=mean(a),c=Array(a[0]).fill(0),d=0;d<a.length;d++)for(var e=0;e<a[d].length;e++)c[e]+=(a[d][e]-b[e])*(a[d][e]-b[e]);return c.map(function(b){return b/a.length})}for(var b=mean(a),c=0,d=0;d<a.length;d++)c+=(a[d]-b)*(a[d]-b);return c/a.length}function mean(a){if(0==a.length)return 0;if(isArray(a[0])){for(var b=Array(a[0].length).fill(0),c=0;c<a.length;c++)for(var d=0;d<a[c].length;d++)b[d]+=a[c][d];return b.map(function(b){return b/a.length})}for(var b=0,c=0;c<a.length;c++)b+=a[c];return b/a.length}function std(a){return 0==a.length?0:isArray(a[0])?variance(a).map(function(a){return Math.sqrt(a)}):Math.sqrt(variance(a))}function L1_norm(a){return 0==a.length?0:a.reduce(function(a,b,c){return a+Math.abs(b)},0)}function L2_norm(a){if(0==a.length)return 0;var b=a.reduce(function(a,b,c){return a+b*b},0);return Math.sqrt(b)}function dotp(a,b){for(var c=0,d=0;d<a.length;d++)c+=a[d]*b[d];return c}function mult_m(a,b){}function isArray(a){return"[object Array]"===Object.prototype.toString.call(a)}